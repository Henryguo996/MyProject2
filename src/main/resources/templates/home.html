<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>é˜¿å’Œçš„è³¼ç‰©ç¶²ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}" />

</head>
<body>
<!-- å…±ç”¨ header -->
<div th:replace="~{fragments/header :: siteHeader}"></div>



<main class="all-products">

    <!-- ç½®ä¸­æ¨™é¡Œå€ -->
    <div class="container text-center my-4">
        <h2 class="fw-bold text-primary border-bottom pb-2 d-inline-block">ğŸ”¥ ç†±è³£å•†å“ ğŸ”¥</h2>
    </div>

    <!-- Bootstrap è¼ªæ’­å€ -->
    <div id="mainCarousel" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="3000">
        <!-- æŒ‡ç¤ºå™¨ï¼ˆå°åœ“é»ï¼‰ -->
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="åœ–ç‰‡ 1"></button>
            <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="1" aria-label="åœ–ç‰‡ 2"></button>
            <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="2" aria-label="åœ–ç‰‡ 3"></button>
        </div>

        <!-- è¼ªæ’­åœ–ç‰‡ -->
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="/images/product_images/product_image1.jpg" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="ä¿ƒéŠ·åœ– 1">
            </div>
            <div class="carousel-item">
                <img src="/images/product_images/product_image2.jpg" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="ä¿ƒéŠ·åœ– 2">
            </div>
            <div class="carousel-item">
                <img src="/images/product_images/product_image3.jpg" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="ä¿ƒéŠ·åœ– 3">
            </div>
        </div>

        <!-- å·¦å³æ§åˆ¶ç®­é ­ -->
        <button class="carousel-control-prev" type="button" data-bs-target="#mainCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">ä¸Šä¸€å¼µ</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#mainCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">ä¸‹ä¸€å¼µ</span>
        </button>
    </div>


    <!-- å•†å“æœå°‹èˆ‡æ’åºå€ -->
    <section class="container mb-4">
        <div class="row align-items-center justify-content-between">
            <!-- å·¦å´ï¼šæ¨™é¡Œèˆ‡æœå°‹æ¬„ -->
            <div class="col-md-8 mb-3 mb-md-0">
                <h3 class="mb-3 fw-bold text-secondary">ğŸ” å…¨ç«™å•†å“æœå°‹</h3>
                <form th:action="@{/?page=1}" method="get" class="d-flex" role="search">
                    <input class="form-control me-2" type="search" name="keyword" placeholder="è¼¸å…¥å•†å“åç¨±é—œéµå­—"
                           aria-label="æœå°‹" th:value="${keyword}">
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="fa-solid fa-magnifying-glass"></i> æœå°‹
                    </button>
                </form>
            </div>

            <!-- å³å´ï¼šæ’åºé¸å–® -->
            <div class="col-md-4">
                <label for="sortSelect" class="form-label fw-semibold">æ’åºæ–¹å¼</label>
                <select id="sortSelect" name="sort" class="form-select" onchange="handleSortChange(this)">
                    <option value="newest">æ—¥æœŸï¼ˆæ–° â†’ èˆŠï¼‰</option>
                    <option value="oldest">æ—¥æœŸï¼ˆèˆŠ â†’ æ–°ï¼‰</option>
                    <option value="hot" selected>ç†±è³£åº¦</option>
                    <option value="priceHigh">åƒ¹æ ¼ï¼ˆé«˜ â†’ ä½ï¼‰</option>
                    <option value="priceLow">åƒ¹æ ¼ï¼ˆä½ â†’ é«˜ï¼‰</option>
                </select>
            </div>
        </div>
    </section>


    <section class="container my-5">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
                <div class="col" th:each="p : ${products}">
                    <div class="card h-100 shadow-sm">
                        <a th:href="@{'/product/' + ${p.id}}">
                            <img th:src="@{${p.imageUrl}}" th:alt="${p.name}" class="card-img-top" style="height: 214px; object-fit: cover;" />
                        </a>
                        <div class="card-body d-flex flex-column justify-content-between">
                            <div>
                                <h5 class="card-title mb-2" th:text="${p.name}">å•†å“åç¨±</h5>
                                <p class="card-text text-danger fw-bold">NT$ <span th:text="${p.price}">0</span></p>
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2 w-100"
                                    th:attr="data-id=${p.id}" onclick="addToCart(this)">
                                <i class="fa-solid fa-cart-plus me-1"></i> åŠ å…¥è³¼ç‰©è»Š
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>


    <section class="container mb-5">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <!-- ç¸½é æ•¸èˆ‡ä¸‹æ‹‰è·³é  -->
            <div class="mb-2">
                <span class="me-2">å…± <strong th:text="${totalPages}">0</strong> é </span>
                <label for="pageSelect" class="me-1">è·³è‡³</label>
                <select id="pageSelect" class="form-select d-inline-block w-auto"
                        onchange="location.href='/?page=' + this.value">
                    <option th:each="i : ${#numbers.sequence(1, totalPages)}"
                            th:value="${i}"
                            th:text="${i}"
                            th:selected="${i == currentPage}"></option>
                </select> é 
            </div>

            <!-- åˆ†é æŒ‰éˆ• -->
            <nav>
                <ul class="pagination mb-0">
                    <!-- ä¸Šä¸€é  -->
                    <li class="page-item" th:if="${currentPage > 1}">
                        <a class="page-link" th:href="@{'/?page=' + ${currentPage - 1}}">ä¸Šä¸€é </a>
                    </li>

                    <!-- é ç¢¼åˆ—è¡¨ -->
                    <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                        th:classappend="${i == currentPage} ? 'active'">
                        <a class="page-link" th:href="@{'/?page=' + ${i}}" th:text="${i}"></a>
                    </li>

                    <!-- ä¸‹ä¸€é  -->
                    <li class="page-item" th:if="${currentPage < totalPages}">
                        <a class="page-link" th:href="@{'/?page=' + ${currentPage + 1}}">ä¸‹ä¸€é </a>
                    </li>
                </ul>
            </nav>
        </div>
    </section>


</main>




<footer class="bg-dark text-white py-4 mt-5">
    <div class="container">
        <div class="row align-items-center text-center text-md-start">
            <!-- LOGOå€ -->
            <div class="col-md-4 mb-3 mb-md-0 d-flex flex-column align-items-center align-items-md-start">
                <a th:href="@{/}" class="text-white text-decoration-none d-flex align-items-center">
                    <img src="/images/icons/logo.svg" alt="logo" style="width: 40px; height: 40px;" class="me-2" />
                    <h5 class="mb-0">é˜¿å’Œçš„è³¼ç‰©ç¶²ç«™</h5>
                </a>
            </div>

            <!-- ç¤¾ç¾¤é€£çµå€ -->
            <div class="col-md-8">
                <div class="d-flex flex-wrap justify-content-center justify-content-md-end gap-3">
                    <a href="#" class="d-flex align-items-center text-white text-decoration-none">
                        <img src="/images/icons/facebook.svg" alt="facebook" class="me-2" style="width: 24px;" />
                        <span>Facebook</span>
                    </a>
                    <a href="#" class="d-flex align-items-center text-white text-decoration-none">
                        <img src="/images/icons/instagram.svg" alt="instagram" class="me-2" style="width: 24px;" />
                        <span>Instagram</span>
                    </a>
                    <a href="#" class="d-flex align-items-center text-white text-decoration-none">
                        <img src="/images/icons/youtube.svg" alt="youtube" class="me-2" style="width: 24px;" />
                        <span>YouTube</span>
                    </a>
                    <a href="#" class="d-flex align-items-center text-white text-decoration-none">
                        <img src="/images/icons/line.svg" alt="line" class="me-2" style="width: 24px;" />
                        <span>LINEå®˜æ–¹å¸³è™Ÿ</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

        function handleSortChange(selectElement) {
            const selectedValue = selectElement.value;
            const url = new URL(window.location.href);
            url.searchParams.set("sort", selectedValue);
            url.searchParams.set("page", 1);
            // åˆ‡å›ç¬¬ä¸€é 
            window.location.href = url.toString();
    }

    //åŠ å…¥è³¼ç‰©è»Šåœ–ç¤º
    async function addToCart(button) {
        const productId = button.getAttribute('data-id');
        try {
            const response = await fetch(`/cart/add/${productId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            if (response.ok) {
                alert('âœ… å·²åŠ å…¥è³¼ç‰©è»Šï¼');
                updateCartCount(); // æ›´æ–°å³ä¸Šè§’è³¼ç‰©è»Šæ•¸é‡
            } else {
                alert('âŒ åŠ å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        } catch (err) {
            console.error(err);
            alert('âš  ç³»çµ±éŒ¯èª¤ï¼Œç„¡æ³•åŠ å…¥è³¼ç‰©è»Š');
        }
    }

    // å¦‚æœç¶²å€åŒ…å« ?logout=trueï¼Œå°±è·³å‡ºæç¤º
    if (window.location.search.includes("logout=true")) {
        alert("æ‚¨å·²æˆåŠŸç™»å‡ºï¼");
        // æ¸…é™¤ç¶²å€åƒæ•¸
        window.history.replaceState(null, "", window.location.pathname);
    }

   async function updateCartCount() {
        try {
            const response = await fetch('/cart/count');
            const count = await response.text();
            document.getElementById('cart-count').innerText = count;
        } catch (error) {
            console.error('æ›´æ–°è³¼ç‰©è»Šæ•¸é‡å¤±æ•—:', error);
        }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œä¸€æ¬¡
    updateCartCount();

    // æ¯ 3 ç§’æ›´æ–°ä¸€æ¬¡
    setInterval(updateCartCount, 3000);
</script>

</body>